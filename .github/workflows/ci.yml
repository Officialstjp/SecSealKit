# CI Pipeline - Runs on every push and PR
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore src/SecSealKit/SecSealKit.csproj

      - name: Build
        run: dotnet build src/SecSealKit/SecSealKit.csproj --configuration Release --no-restore

      - name: Copy DLL to module root
        run: Copy-Item -Path "src/SecSealKit/bin/Release/netstandard2.0/SecSealKit.dll" -Destination "SecSealKit.dll" -Force
        shell: pwsh

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          # Install Pester if not present
          if (-not (Get-Module -ListAvailable -Name Pester | Where-Object Version -ge 5.0)) {
              Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          }
          Import-Module Pester -MinimumVersion 5.0

          # Import the module
          Import-Module .\SecSealKit.psd1 -Force

          # Run tests
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'testResults.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'

          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
              throw "$($result.FailedCount) test(s) failed"
          }

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: testResults.xml
          retention-days: 7

      - name: Verify module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path .\SecSealKit.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          Write-Host "Cmdlets: $($manifest.ExportedCmdlets.Keys -join ', ')"
          Write-Host "Aliases: $($manifest.ExportedAliases.Keys -join ', ')"
