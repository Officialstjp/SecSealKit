# Release Pipeline - Manual trigger for PSGallery publishing
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.3.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore src/SecSealKit/SecSealKit.csproj

      - name: Build Release
        run: dotnet build src/SecSealKit/SecSealKit.csproj --configuration Release --no-restore

      - name: Copy DLL to module root
        shell: pwsh
        run: Copy-Item -Path "src/SecSealKit/bin/Release/netstandard2.0/SecSealKit.dll" -Destination "SecSealKit.dll" -Force

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          # Install Pester if not present
          $pester = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [Version]'5.0.0' }
          if (-not $pester) {
              Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          }
          Import-Module Pester -MinimumVersion 5.0.0
          Import-Module .\SecSealKit.psd1 -Force

          $config = New-PesterConfiguration
          $config.Run.Path = './tests/SecSealKit.Tests.ps1'
          $config.Run.Exit = $true
          $config.Output.Verbosity = 'Detailed'

          Invoke-Pester -Configuration $config

      - name: Update module version
        shell: pwsh
        run: |
          $manifestPath = '.\SecSealKit.psd1'
          $content = Get-Content $manifestPath -Raw
          $content = $content -replace "ModuleVersion\s*=\s*'[^']*'", "ModuleVersion = '${{ inputs.version }}'"
          Set-Content $manifestPath -Value $content -NoNewline

      - name: Test module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path .\SecSealKit.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"

      - name: Prepare module for publishing
        shell: pwsh
        run: |
          $publishDir = 'publish/SecSealKit'
          New-Item -Path $publishDir -ItemType Directory -Force | Out-Null

          # Copy module files
          Copy-Item -Path 'SecSealKit.psd1' -Destination $publishDir
          Copy-Item -Path 'SecSealKit.dll' -Destination $publishDir
          Copy-Item -Path 'LICENSE' -Destination $publishDir
          Copy-Item -Path 'NOTICE' -Destination $publishDir
          Copy-Item -Path 'README.md' -Destination $publishDir

          # Verify
          Get-ChildItem $publishDir -Recurse | Format-Table Name, Length

      - name: Publish to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $publishDir = 'publish/SecSealKit'
          Publish-Module -Path $publishDir -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose

      - name: Create ZIP for release
        shell: pwsh
        run: Compress-Archive -Path "publish/SecSealKit/*" -DestinationPath "SecSealKit-${{ inputs.version }}.zip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: SecSealKit-${{ inputs.version }}
          path: publish/SecSealKit/
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: SecSealKit v${{ inputs.version }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            SecSealKit-${{ inputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
